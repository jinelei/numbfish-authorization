<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jinelei.iotgenius.auth.client.mapper.RoleMapper">

    <select id="getRoleWithPermissions" resultMap="RoleWithPermissionsResultMap">
        SELECT r.*, p.*
        FROM role r
        LEFT JOIN role_permission rp ON r.id = rp.role_id
        LEFT JOIN permission p ON rp.permission_id = p.id
        WHERE r.id = #{roleId}
    </select>
    <resultMap id="RoleWithPermissionsResultMap" type="com.jinelei.iotgenius.auth.client.domain.RoleEntity">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <collection property="whitePermissions" ofType="com.jinelei.iotgenius.auth.client.domain.PermissionEntity">
            <id property="id" column="p_id"/>
            <result property="name" column="p_name"/>
        </collection>
    </resultMap>

    <select id="getRoleTreeByIds" resultType="com.jinelei.iotgenius.auth.client.domain.RoleEntity">
        <choose>
            <when test="ids != null and ids.size() > 0">
                WITH RECURSIVE role_tree AS (
                    SELECT
                        id,
                        name,
                        code,
                        sort_value,
                        parent_id,
                        0 AS level
                    FROM
                        role
                    WHERE
                        id IN
                        <foreach item="id" collection="ids" open="(" separator="," close=")">
                            #{id}
                        </foreach>
                    UNION ALL
                    SELECT
                        p.id,
                        p.name,
                        p.code,
                        p.sort_value,
                        p.parent_id,
                        pt.level + 1
                    FROM
                        role p
                    JOIN
                        role_tree pt ON p.parent_id = pt.id
                )
                SELECT
                    id,
                    name,
                    code,
                    sort_value,
                    parent_id
                FROM
                    role_tree
                ORDER BY
                    level, sort_value;
            </when>
            <otherwise>
                WITH RECURSIVE role_tree AS (
                    SELECT
                        id,
                        name,
                        code,
                        sort_value,
                        parent_id,
                        0 AS level
                    FROM
                        role
                    WHERE
                        parent_id IS NULL OR parent_id = 0
                    UNION ALL
                    SELECT
                        p.id,
                        p.name,
                        p.code,
                        p.sort_value,
                        p.parent_id,
                        pt.level + 1
                    FROM
                        role p
                    JOIN
                        role_tree pt ON p.parent_id = pt.id
                )
                SELECT
                    id,
                    name,
                    code,
                    sort_value,
                    parent_id
                FROM
                    role_tree
                ORDER BY
                    level, sort_value;
            </otherwise>
        </choose>
    </select>

    <select id="getRoleTreeByIds1" resultType="com.jinelei.iotgenius.auth.client.domain.RoleEntity">
    WITH RECURSIVE role_tree AS (
                    SELECT
                        id,
                        name,
                        code,
                        sort_value,
                        parent_id,
                        0 AS level,
                        CAST(id AS CHAR(1023)) AS ancestor
                    FROM
                        role
                    WHERE
                        parent_id is null
                    UNION ALL
                    SELECT
                        p.id,
                        p.name,
                        p.code,
                        p.sort_value,
                        p.parent_id,
                        pt.level + 1,
                        CONCAT(pt.ancestor, ',', CAST(p.id AS CHAR(1023)))
                    FROM
                        role p
                    JOIN
                        role_tree pt ON p.parent_id = pt.id
                )
                SELECT
                    id,
                    name,
                    code,
                    sort_value,
                    parent_id,
                    level,
                    ancestor
                FROM
                    role_tree
                ORDER BY
                    level, sort_value;
    </select>

</mapper>
